---
output:
  html_document: default
  word_document: default
  pdf_document: default
---
```{r knitr_setup, echo=FALSE, message=FALSE}
knitr::opts_chunk$set(cache=FALSE)
library(tidyverse)
library(dplyr)
library(tidyr)
library(ggplot2)
```

## Tutorial: An Analysis of Roger Federer, Rafael Nadal and Novak Djokovic

### Background
Currently, tennis is experiencing the end of a "Golden Age". Right now, there are three all time greats competing at the highest stage; all while being at the closing door of their careers. These three are Roger Federer, Rafael Nadal and Novak Djokovic.

Roger Federer is widely considered the greatest of all time (GOAT). He has broken countless records and received many awards. Even at the age of 36, Roger Federer still is at the top of the rankings and continues to be a favorite for all of the biggest tournaments. You can look at his career statistics here:

https://en.wikipedia.org/wiki/Roger_Federer_career_statistics

Rafael Nadal is considered the other main contender for greatest tennis player of all time status. He is considered the greatest clay court player of all time and joins Federer at the top of the rankings even today, at the age of 31. You can look at his career statistics here:

https://en.wikipedia.org/wiki/Rafael_Nadal_career_statistics

Novak Djokovic is the youngest of the three, and after playing 3rd fiddle to Federer and Nadal, burst on to the scene in 2011 to take the crown at the top and completely dominate the tour at unprecedented levels from 2011 to 2016. Although he does not yet have the career accomplishments to equal Roger Federer or Rafael Nadal, he is considered a huge threat to his legacy. He is currently recovering from surgery at the moment, but could return into grand slam winning form soon. You can look at his career statistics here:

https://en.wikipedia.org/wiki/Novak_Djokovic_career_statistics

This tutorial will take you through the entire data science pipeline, as we explore the performance of these three all time greats throughout their careers.

### Gathering and Tidying The Data
First we need to gather data for all grand slam tournaments. We can find all ATP Men's matches from 2000 to 2016 at this link:
https://www.kaggle.com/jordangoblet/atp-tour-20002016

For Tennis Fans: It is important to note that Federer and Nadal have won many many matches in 2017 and 2018 and are currently ranked number 1 and 2 right now. This data will be missing and not be included in the study due to the years not being covered in the dataset.

As you can see below, we have loaded the data.

```{r load_data, message=FALSE}
tennis <- read.csv("/Users/Devin/Documents/Data.csv")
head(tennis)
```

Now, there are a lot of attributes that we do not really need. Let's tidy up the data a little bit.

We can select only the attributes that we plan on using:

- We do not need the location, since that informtion will not be necessary for this analysis since players pick and choose the tournaments they enter.
- We do not need the court type because most courts are outdoor and this analysis will not cover whether or not the court is outdoor or indoor (because we have a lot of more important things to analyze)
- We can safely get rid of a lot of the extra match stats like UBW, UBL, etc since those are match specific stats that aren't picked up for most tournaments.
- Now, we need a few match attributes: Round, Winner, Loser, WRank, LRank, W1, L1, W2, L2, W3, L3, W4, L4, W5, L5, Wsets, Lsets
- I'm also going to rename Best.of to BestOf because I am OCD.

```{r}
tennis <- tennis %>%
  select(Tournament, Date, Surface, Best.of, Series, Round, Winner, Loser, WRank, LRank, W1, L1, W2, L2, W3, L3, W4, L4, W5, L5, Wsets, Lsets) %>%
  rename(BestOf = Best.of)
head(tennis)
```

Missing data can be a problem. So let's handle this missing data before it messes up any calculations.

- Some players do not have a ranking, so we must replace their ranking with 1000. We can check if LRank is N/A and replace with 0. To do this, we need to convert WRank and LRank to numeric typing.
- Some matches did not play a specific set (Due to injuries, etc), so we must replace those set scores with 0. We can check W1-W5 and L1-L5 for N/A values and replace with 0.

```{r}
tennis$WRank <- suppressWarnings(as.numeric(as.character(tennis$WRank)))
tennis$LRank <- suppressWarnings(as.numeric(as.character(tennis$LRank)))
tennis$LRank[is.na(tennis$LRank)] <- as.factor(1000)

tennis$W1[is.na(tennis$W1)] <- 0
tennis$L1[is.na(tennis$L1)] <- 0
tennis$W2[is.na(tennis$W2)] <- 0
tennis$L2[is.na(tennis$L2)] <- 0
tennis$W3[is.na(tennis$W3)] <- 0
tennis$L3[is.na(tennis$L3)] <- 0
tennis$W4[is.na(tennis$W4)] <- 0
tennis$L4[is.na(tennis$L4)] <- 0
tennis$W5[is.na(tennis$W5)] <- 0
tennis$L5[is.na(tennis$L5)] <- 0

head(tennis)
```

Now, there are a couple of attributes that could be useful but don't yet exist in this data frame. Let's see if we can add them.

- The first will be what we call a rank differential. It is the losing players rank minus the winning players rank. This attribute will be used to determine how big of an upset, rankwise, some matches are. The lower the value is in the negatives, the more of an upset the match was. The only problem is, that WRank and LRank are factors, so we must first convert them to the correct type.
- The second is the number of games won by the winner. We can calculate this by adding up the scores of W1-W5
- The third is the number of games won by the loser. We can calculate this by adding up the scores of L1-L5
- The fourth is Year. We are simply going to cut off the year from the Date attribute. This will help with grouping later on.

```{r, message=FALSE}
tennis <- tennis %>%
  mutate(Differential = LRank - WRank) %>%
  mutate(Wgames = W1 + W2 + W3 + W4 + W5) %>%
  mutate(Lgames = L1 + L2 + L3 + L4 + L5) %>%
  mutate(Year = format(as.Date(tennis$Date, format="%d/%m/%Y"),"%Y")) %>%
  select(Tournament, Year, Date, Surface, BestOf, Series, Round, Winner, Loser, WRank, LRank, Differential, W1, L1, W2, L2, W3, L3, W4, L4, W5, L5, Wsets, Lsets, Wgames, Lgames) 
head(tennis)
```

Now, let's get the individual matches for each player we are interested in. We can use filter to grab all matches where Roger Federer, Rafael Nadal or Novak Djokovic was either the winner or loser, depending on which player the data frame is for. We will be using these three data frames for a lot of analysis to come.

```{r}
rfMatches <- tennis %>%
  filter(Winner == "Federer R." | Loser == "Federer R.")
head(rfMatches)

rnMatches <- tennis %>%
  filter(Winner == "Nadal R." | Loser == "Nadal R.")
head(rnMatches)

ndMatches <- tennis %>%
  filter(Winner == "Djokovic N." | Loser == "Djokovic N.")
head(ndMatches)
```

### Exploratory Data Analysis
Now that we have our data properly prepared. Let's analyze it.

The main cornerstone of being an all time great, is being able to consistently beat top ranked players. So, let's look at how each of our all time greats perform against top 20 ranked players. 

So, to do this, we are going to take the data frame and filter out all losing players greater than 20 (Which in the case of tennis, would be a worse rank). We also will group by year so that we can plot our player's top 20 wins per yearly season.

After we have the groups, we can summarize these wins by using the n function to calculate the number of top 20 wins each player had for each season/group. Now, for each player we add a Player attribute to help us distinguish which player came from which data frame, and then we bind the three data frames together.

Lastly, we plot a bar graph that displays each player's Top 20 wins side by side for each year.

```{r}
rfTop20 <- rfMatches %>%
  filter(Winner == "Federer R.") %>%
  filter(LRank <= 20) %>%
  group_by(Year) %>%
  summarize(top20Wins = n()) %>%
  mutate(Player = "Federer")

rnTop20 <- rnMatches %>%
  filter(Winner == "Nadal R.") %>%
  filter(LRank <= 20) %>%
  group_by(Year) %>%
  summarize(top20Wins = n()) %>%
  mutate(Player = "Nadal")

ndTop20 <- ndMatches %>%
  filter(Winner == "Djokovic N.") %>%
  filter(LRank <= 20) %>%
  group_by(Year) %>%
  summarize(top20Wins = n()) %>%
  mutate(Player = "Djokovic")

top20 <- rbind(rfTop20, rnTop20, ndTop20)
  
ggplot(top20, mapping = aes(x=Year, y=top20Wins)) + 
  geom_bar(aes(fill = Player), position = "dodge", stat="identity") + 
  ggtitle("Top 20 Wins Per Year") + 
  ylab("Top 20 Wins") + xlab("Year") +
  scale_fill_manual(values=c("#999999", "#56B4E9", "#E69F00"))
  
```

Let's analyze this plot:

- We notice that Djokovic has one year, 2015, where he had over 40 top 20 wins. This was his most dominant year (And the most dominant year for any player in history; Djokovic won most of the tournaments he entered that year and rarely lost)
- We also notice that Federer has great longevity, being able to consistently get more than 20 top 20 wins for 10 different years. To compare, Nadal has more than 20 top20 wins in 4 years while Djokovic has more than 20 top 20 wins in 7 different years.
- We can also see the effect each player has on each other. Federer had a lot of top 20 wins in 2004-2007, but as Nadal and Djokovic started improving in 2008-2016, Federer's amount of wins decreased in the later years.

Nadal looks relatively unimpressive compared to Federer and Djokovic in this plot, but he is considered the greatest clay court player of all time. Let's analyze wins by surface to see if this is true.

First, let's take the data frames and filter for all wins. We also will group by surface.

After we have the groups, we can summarize these wins by using the n function to calculate the wins per surface for each player. Now, for each player we add a Player attribute to help us distinguish which player came from which data frame, and then we bind the three data frames together.

Lastly, we plot a bar graph that displays each player's surface wins side by side.

```{r}
rfSurface <- rfMatches %>%
  filter(Winner == "Federer R.") %>%
  group_by(Surface) %>%
  summarize(surfaceWins = n()) %>%
  mutate(Player = "Federer")

rnSurface <- rnMatches %>%
  filter(Winner == "Nadal R.") %>%
  group_by(Surface) %>%
  summarize(surfaceWins = n()) %>%
  mutate(Player = "Nadal")

ndSurface <- ndMatches %>%
  filter(Winner == "Djokovic N.") %>%
  group_by(Surface) %>%
  summarize(surfaceWins = n()) %>%
  mutate(Player = "Djokovic")

surface <- rbind(rfSurface, rnSurface, ndSurface)

ggplot(surface, mapping = aes(x=Surface, y=surfaceWins)) + 
  geom_bar(aes(fill = Player), position = "dodge", stat="identity") + 
  ggtitle("Wins By Surface") + 
  ylab("Wins") + xlab("Surface") +
  scale_fill_manual(values=c("#999999", "#56B4E9", "#E69F00"))
```

Let's analyze this plot:

- Notice that Rafael Nadal does have the most wins on clay by far. He is leading Djokovic and Federer by a large margin.
- Just as Nadal has the most wins on clay, Federer has by far the most wins on Grass, doubling Djokovic and Nadal. These numbers are relatively low because there aren't many grass tournaments.
- Carpet was a surface that was discontinued in the late 2000s, so most players do not have many wins on Carpet. Federer has more wins than Djokovic and Nadal on Carpet because he is older and was playing more before Carpet's discontinuation.
- Hard courts are the most common surface, so it makes sense that each player would have the most wins on that surface.

One of the biggest contributors to the GOAT (Greatest of All Time) status are Grand Slam tournaments. There are four Grand Slam tournaments each year. These four tournaments, are the most prestigious tournaments in tennis and winning the trophy at one of these four tournaments is considered a great legacy. In the last 12 years, there were only 7 different grand slam champions. Roger Federer, Rafael Nadal and Novak Djokovic have held a sustained period of dominance over grand slams, winning a combined 48 out of the last 59 slams. (Federer winning 20, Nadal winning 16, Djokovic winning 12). 

- Note, Federer and Nadal have won 3 and 2 grand slams, respectively, in 2017 and 2018. So, within the bounds of this dataset, Federer has only 17 grand slam wins and Nadal only has 14 grand slam wins)

Let's look at the amount of grand slam wins each player has won.

First we need to filter out all tournaments with a series that is not "Grand Slam". Then we need to group by tournament.

We can then summarize using the n function to get all wins per slam, and add a Player attribute to help us distinguish which player came from which data frame. Then, we bind the three data frames together.

Lastly, we plot a bar graph that displays each player's grand slam wins side by side.

```{r}
rfSlams <- rfMatches %>%
  filter(Winner == "Federer R.") %>%
  filter(Series == "Grand Slam") %>%
  group_by(Tournament) %>%
  summarize(slamWins = n()) %>%
  mutate(Player = "Federer")

rnSlams <- rnMatches %>%
  filter(Winner == "Nadal R.") %>%
  filter(Series == "Grand Slam") %>%
  group_by(Tournament) %>%
  summarize(slamWins = n()) %>%
  mutate(Player = "Nadal")

ndSlams <- ndMatches %>%
  filter(Winner == "Djokovic N.") %>%
  filter(Series == "Grand Slam") %>%
  group_by(Tournament) %>%
  summarize(slamWins = n()) %>%
  mutate(Player = "Djokovic")

slams <- rbind(rfSlams, rnSlams, ndSlams)

ggplot(slams, mapping = aes(x=Tournament, y=slamWins)) + 
  geom_bar(aes(fill = Player), position = "dodge", stat="identity") + 
  ggtitle("Grand Slam Wins") + 
  ylab("Wins") + xlab("Grand Slam") +
  scale_fill_manual(values=c("#999999", "#56B4E9", "#E69F00"))
```

Let's analyze this plot:

- Nadal has the most French Open wins, which makes sense because the French Open is on clay, his favorite surface.
- Federer has the most Wimbledon wins, which makes sense because Wimbledon is on grass, his favorite surface.
- Djokovic is relatively balanced, winning approximately the same amount of matches for each slam.
- Federer has the most wins for 3 out of the four slams, and the most wins overall. This makes sense because he has won the most grand slam titles, and also has been playing the longest.

So far we've only been looking at wins. However, every player has off days and every player loses. Let's see what the win percentage of these players are for each year.

First we need to assign each match a value for whether or not it was a victory; 1 for win, 0 for loss. Then, we need to group by year. Then, we can use summarize to take the mean of the WonMatch attribute for each group in order to create the winPercentage for that year. We also can take the Season values in order to preserve the Year attribute after summary. Then, we add a Player attribute to help us distinguish which player came from which data frame. Then, we bind the three data frames together.

Lastly, we plot a scatterplot that displays each player's win percentage, for each year.

```{r}
rfFinals <- rfMatches %>%
  mutate(WonMatch = ifelse(Winner == "Federer R.", 1, 0)) %>%
  mutate(Season = Year) %>%
  group_by(Year) %>%
  summarize(WinPercentage = mean(WonMatch), Season = median(as.numeric(Season))) %>%
  mutate(Player = "Federer") %>%
  select(Player, Season, WinPercentage)

rnFinals <- rnMatches %>%
  mutate(WonMatch = ifelse(Winner == "Nadal R.", 1, 0)) %>%
  mutate(Season = Year) %>%
  group_by(Year) %>%
  summarize(WinPercentage = mean(WonMatch), Season = median(as.numeric(Season))) %>%
  mutate(Player = "Nadal") %>%
  select(Player, Season, WinPercentage)

ndFinals <- ndMatches %>%
  mutate(WonMatch = ifelse(Winner == "Djokovic N.", 1, 0)) %>%
  mutate(Season = Year) %>%
  group_by(Year) %>%
  summarize(WinPercentage = mean(WonMatch), Season = median(as.numeric(Season))) %>%
  mutate(Player = "Djokovic") %>%
  select(Player, Season, WinPercentage)

finals <- rbind(rfFinals, rnFinals, ndFinals)

ggplot(finals, mapping = aes(x=Season, y=WinPercentage)) + 
  geom_point(aes(color = Player)) + 
  ggtitle("Win Percentage Over Time") + 
  ylab("Win Percentage") + xlab("Year") +
  scale_color_manual(values=c("#999999", "#56B4E9", "#E69F00"))
```

Let's analyze this plot:

- Federer and Djokovic both have 3 years where they had over a 0.9 win percentage
- In comparison, Nadal only had 1 year with over a 0.9 win percentage
- We can see that Federer's win percentage peaked in 2004-2006 and slowly moved downwards, likely due to Nadal (And then later Djokovic) rising through the ranks.
- All three players had relatively low win percentages in the early stages of their career, except for Djokovic. This is because Djokovic was really young in 2004 and started his season towards the end of the year which did not give him many matches.

Now let's see how the Win Percentages look if they are standardized.

To standardize, we follow this formula:
(winPercentage - meanWinPercentage) / sdPercentage

To learn more about standardizing values:

http://www.statisticshowto.com/standardized-values-examples/

So first, we need to find the mean and standard deviation of our win percentages. We can do this by using the summarize function and then assigning them to two variables.

Next, we can use mutate to create the standardized win percentage, using the formula above.

Then, we can plot a scatterplot of the standardized win percentages.

```{r}
newFinals <- finals %>%
  summarize(MeanPercentage = mean(WinPercentage), sdPercentage = sd(WinPercentage))

meanWinPercentage <-newFinals$MeanPercentage
sdPercentage <- newFinals$sdPercentage

standardized <- finals %>%
  mutate(standardizedPercentage = (WinPercentage - meanWinPercentage)/sdPercentage)

ggplot(standardized, mapping = aes(x=Season, y=standardizedPercentage)) + 
  geom_point(aes(color = Player)) + 
  ggtitle("Standardized Win Percentage Over Time") + 
  ylab("Standardized Win Percentage") + xlab("Year") +
  scale_color_manual(values=c("#999999", "#56B4E9", "#E69F00"))
```

Let's briefly analyze this plot:

- Djokovic is the only player who has standardized win percentages below -2
- Federer has three years where he had a standardized win percentage at 1 or above.
- Djokovic only had one year with a standardized win percentage of 1.
- Nadal did not break 1 in terms of standardized win percentages.
- Federer is the only player to have a standardized win percentage greater than 1.

Based on these last few scatterplots, we can easily tell that Federer, Nadal and Djokovic in their primes did not lose very often. However, there are certain rare occasions where they get upset by a lower ranked player. Let's take a look at these upsets.

Remember the Match Differential attribute we created earlier? Well now we can finally use it. The match differential is a measure that determines how big of an upset the match was. For big upsets, let's look at all matches with a differential less than or equal to -100

So let's take each data frame and use filter to get all matches where our player has lost a match with a differential less than or equal to -100. Then, lets bind all three data frames together.

```{r}
rfUpsets <- rfMatches %>%
  filter(Loser == "Federer R.") %>%
  filter(Differential <= -100)

rnUpsets <- rnMatches %>%
  filter(Loser == "Nadal R.") %>%
  filter(Differential <= -100)

ndUpsets <- ndMatches %>%
  filter(Loser == "Djokovic N.") %>%
  filter(Differential <= -100)

upsets <- rbind(rfUpsets, rnUpsets, ndUpsets)
upsets %>% select(Tournament, Year, Winner, Loser, Surface, Round, WRank, LRank, Differential)
```

Let's briefly analyze this table:

- Djokovic seems to get upset the least, having only 4 big upsets, to Nadal's 8 and Federer's 6.
- Nadal has the biggest upset, against Johansson, with a differential of -688, which is way lower than other differentials (The second lowest is -317, which was a match Djokovic lost against Krajinovic)
- I think the most important takeaway is how few upsets there are. Federer, Nadal and Djokovic play hundreds (Over 1000 for Federer) of matches, and only had 6, 8 and 4 big upsets, respectively. This stat is a testament to how consistently good these players are.

Despite there being some bad losses above, in most cases, a match that involves Federer, Nadal or Djokovic is very quick and easy for them. Let's analyze their dominant performances.

First we filter out matches that do not result in a victory for our respective player. Then, we only keep matches where the loser got 5 games or less; this means that Federer/Nadal/Djokovic was able to beat the opponent in straight sets while dropping minimal games. Then, we used the summarize function to take the number of dominant matches for each player and added a Player attribute to help us distinguish which player came from which data frame. 

We also should make a separate data frame, that totals up all wins for each player, using a similar process. We then join those two tables together.

Then, we bind the three data frames together and displayed as a table.

```{r}
dominantRF <- rfMatches %>%
  filter(Winner == "Federer R.") %>%
  filter(Lgames <= 5) %>%
  summarize(DominantWins = n()) %>%
  mutate(Player = "Federer")

rfWins <- rfMatches %>%
  filter(Winner == "Federer R.") %>%
  summarize(TotalWins = n()) %>%
  mutate(Player = "Federer")

dominantRN <- rnMatches %>%
  filter(Winner == "Nadal R.") %>%
  filter(Lgames <= 5) %>%
  summarize(DominantWins = n()) %>%
  mutate(Player = "Nadal")

rnWins <- rnMatches %>%
  filter(Winner == "Nadal R.") %>%
  summarize(TotalWins = n()) %>%
  mutate(Player = "Nadal")

dominantND <- ndMatches %>%
  filter(Winner == "Djokovic N.") %>%
  filter(Lgames <= 5) %>%
  summarize(DominantWins = n()) %>%
  mutate(Player = "Djokovic")

ndWins <- ndMatches %>%
  filter(Winner == "Djokovic N.") %>%
  summarize(TotalWins = n()) %>%
  mutate(Player = "Djokovic")

dominantRF <- dominantRF %>%
  left_join(rfWins, by="Player")

dominantRN <- dominantRN %>%
  left_join(rnWins, by="Player")

dominantND <- dominantND %>%
  left_join(ndWins, by="Player")

dominant <- rbind(dominantRF, dominantRN, dominantND)
dominant %>% select(Player, TotalWins, DominantWins)
```

Let's briefly analyze this table:

- Nadal is the player with the most dominant wins
- Federer, despite having way more total wins, still has less dominant wins than Nadal.

### Hypothesis Testing & Machine Learning



### Message

