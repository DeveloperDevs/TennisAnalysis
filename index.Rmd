---
output:
  html_document: default
  word_document: default
  pdf_document: default
---
```{r knitr_setup, echo=FALSE, message=FALSE}
knitr::opts_chunk$set(cache=TRUE)
library(tidyverse)
library(dplyr)
library(tidyr)
library(ggplot2)
```

## Tutorial: An Analysis of Roger Federer, Rafael Nadal and Novak Djokovic in Grand Slams

### Background
Currently, tennis is experiencing the end of a "Golden Age". Right now, there are three all time greats competing at the highest stage; all while being at the closing door of their careers. These three are Roger Federer, Rafael Nadal and Novak Djokovic.

Roger Federer is widely considered the greatest of all time (GOAT). He has broken countless records and received many awards. Even at the age of 36, Roger Federer still is at the top of the rankings and continues to be a favorite for all of the biggest tournaments.

Rafael Nadal is considered the other main contender for greatest tennis player of all time status. He is considered the greatest clay court player of all time and joins Federer at the top of the rankings even today, at the age of 31

Novak Djokovic is the youngest of the three, and after playing 3rd fiddle to Federer and Nadal, burst on to the scene in 2011 to take the crown at the top and completely dominate the tour at unprecedented levels from 2011 to 2016. Although he does not yet have the career accomplishments to equal Roger Federer or Rafael Nadal, he is considered a huge threat to his legacy. He is currently recovering from surgery at the moment, but could return into grand slam winning for soon.

One of the biggest contributors to the GOAT (Greatest of All Time) status are Grand Slam tournaments. There are four Grand Slam tournaments each year. These four tournaments, are the most prestigious tournaments in tennis and winning the trophy at one of these four tournaments is considered a great legacy. In the last 12 years, there were only 7 different grand slam champions. Roger Federer, Rafael Nadal and Novak Djokovic have held a sustained period of dominance over grand slams, winning a combined 48 out of the last 59 slams. (Federer winning 20, Nadal winning 16, Djokovic winning 12)

This tutorial will take you through the entire data science pipeline, as we explore the performance of these three all time greats in the grand slam tournaments that they've participated in throughout their careers.

### Gather and Tidying The Data
First we need to gather data for all grand slam tournaments. We can find all ATP Men's matches from 2000 to 2016 at this link:
https://www.kaggle.com/jordangoblet/atp-tour-20002016

For Tennis Fans: It is important to note that Federer and Nadal have won a combined total of 5 grand slams in 2017 and 2018. This data will be missing and not be included in the study due to the statistics not being released by the ATP world tour.

As you can see below, we have loaded the data.

```{r load_data, message=FALSE}
tennis <- read.csv("/Users/Devin/Documents/Data.csv")
head(tennis)
```

First, since this tutorial only concerns grand slam matches, we can filter out all non grand slam matches.

So first, let's put the matches into a pipeline and use filter to keep all matches with a Series attribute of "Grand Slam".

```{r}
slamMatches <- tennis %>%
  filter(Series == "Grand Slam") 
head(slamMatches)
```

Now, there are a lot of attributes that we do not really need. Let's tidy up the data a little bit.

We can select only the attributes that we plan on using:

- Since there are only 4 grand slams, we don't need the location or series, just the tournament name.
- We do not need the court type because every single grand slam is outdoor, we only care about the surface for court conditions.
- We do not need best.of because every grand slam match is best of 5.
- Now, we need a few match attributes: Round, Winner, Loser, WRank, LRank, W1, L1, W2, L2, W3, L3, W4, L4, W5, L5, Wsets, Lsets

```{r}
slamMatches <- slamMatches %>%
  select(Tournament, Date, Surface, Round, Winner, Loser, WRank, LRank, W1, L1, W2, L2, W3, L3, W4, L4, W5, L5, Wsets, Lsets) 
head(slamMatches)
```

Missing data can be a problem. So let's handle this missing data before it messes up any calculations.

- Some players do not have a ranking, so we must replace their ranking with 1000. We can check if LRank is N/A and replace with 0. To do this, we need to convert WRank and LRank to numeric typing.
- Some matches did not play a specific set (Due to injuries, etc), so we must replace those set scores with 0. We can check W1-W5 and L1-L5 for N/A values and replace with 0.

```{r}
slamMatches$WRank <- suppressWarnings(as.numeric(as.character(slamMatches$WRank)))
slamMatches$LRank <- suppressWarnings(as.numeric(as.character(slamMatches$LRank)))
slamMatches$LRank[is.na(slamMatches$LRank)] <- as.factor(1000)

slamMatches$W1[is.na(slamMatches$W1)] <- 0
slamMatches$L1[is.na(slamMatches$L1)] <- 0
slamMatches$W2[is.na(slamMatches$W2)] <- 0
slamMatches$L2[is.na(slamMatches$L2)] <- 0
slamMatches$W3[is.na(slamMatches$W3)] <- 0
slamMatches$L3[is.na(slamMatches$L3)] <- 0
slamMatches$W4[is.na(slamMatches$W4)] <- 0
slamMatches$L4[is.na(slamMatches$L4)] <- 0
slamMatches$W5[is.na(slamMatches$W5)] <- 0
slamMatches$L5[is.na(slamMatches$L5)] <- 0

head(slamMatches)
```

Now, there are a couple of attributes that could be useful but don't yet exist in this data frame. Let's see if we can add them.

- The first will be what we call a rank differential. It is the losing players rank minus the winning players rank. This attribute will be used to determine how big of an upset, rankwise, some matches are. The lower the value is in the negatives, the more of an upset the match was. The only problem is, that WRank and LRank are factors, so we must first convert them to the correct type.
- The second is the number of games won by the winner. We can calculate this by adding up the scores of W1-W5
- The third is the number of games won by the loser. We can calculate this by adding up the scores of L1-L5
- The fourth is Year. We are simply going to cut off the year from the Date attribute. Because all slams are at relatively the same date each year.

```{r, message=FALSE}
slamMatches <- slamMatches %>%
  mutate(Differential = LRank - WRank) %>%
  mutate(Wgames = W1 + W2 + W3 + W4 + W5) %>%
  mutate(Lgames = L1 + L2 + L3 + L4 + L5) %>%
  mutate(Year = format(as.Date(slamMatches$Date, format="%d/%m/%Y"),"%Y")) %>%
  select(Tournament, Year, Date, Surface, Round, Winner, Loser, WRank, LRank, Differential, W1, L1, W2, L2, W3, L3, W4, L4, W5, L5, Wsets, Lsets, Wgames, Lgames) 
head(slamMatches)
```

Now, let's get the individual matches for each player we are interested in. We can use filter to grab all matches where Roger Federer, Rafael Nadal or Novak Djokovic was either the winner or loser, depending on which player the data frame is for. We will be using these three data frames for a lot of analysis to come.

```{r}
rfMatches <- slamMatches %>%
  filter(Winner == "Federer R." | Loser == "Federer R.")
head(rfMatches)

rnMatches <- slamMatches %>%
  filter(Winner == "Nadal R." | Loser == "Nadal R.")
head(rnMatches)

ndMatches <- slamMatches %>%
  filter(Winner == "Djokovic N." | Loser == "Djokovic N.")
head(ndMatches)
```

### Exploratory Data Analysis
Now that we have our data properly prepared. Let's analyze it.

The main cornerstone of being an all time great, is being able to consistently beat top ranked players at the biggest tournaments. So, let's look at how each of our all time greats perform against top 20 ranked players. 

So, to do this, we are going to take the data frame and filter out all losing players greater than 20 (Which in the case of tennis, would be a worse rank). We also will group by year so that we can plot our player's top 20 wins per yearly season.

After we have the groups, we can summarize these wins by using the n function to calculate the number of top 20 wins each player had for each season/group. Now, for each player we add a Player attribute to help us distinguish which player came from which data frame, and then we bind the three data frames together.

Then, we plot a bar graph that displays each player's Top 20 wins side by side.

```{r}
rfTop20 <- rfMatches %>%
  filter(Winner == "Federer R.") %>%
  filter(LRank <= 20) %>%
  group_by(Year) %>%
  summarize(top20Wins = n()) %>%
  mutate(Player = "Federer")

rnTop20 <- rnMatches %>%
  filter(Winner == "Nadal R.") %>%
  filter(LRank <= 20) %>%
  group_by(Year) %>%
  summarize(top20Wins = n()) %>%
  mutate(Player = "Nadal")

ndTop20 <- ndMatches %>%
  filter(Winner == "Djokovic N.") %>%
  filter(LRank <= 20) %>%
  group_by(Year) %>%
  summarize(top20Wins = n()) %>%
  mutate(Player = "Djokovic")

top20 <- rbind(rfTop20, rnTop20, ndTop20)
  
ggplot(top20, mapping = aes(x=Year, y=top20Wins)) + 
  geom_bar(aes(fill = Player), position = "dodge", stat="identity") + 
  ggtitle("Top 20 Wins Per Year") + 
  ylab("Top 20 Wins") + xlab("Year") +
  scale_fill_manual(values=c("#999999", "#56B4E9", "#E69F00"))
  
```

We can also do the same for top 10 wins:

```{r}
rfTop10 <- rfMatches %>%
  filter(Winner == "Federer R.") %>%
  filter(LRank <= 10) %>%
  group_by(Year) %>%
  summarize(top10Wins = n()) %>%
  mutate(Player = "Federer")

rnTop10 <- rnMatches %>%
  filter(Winner == "Nadal R.") %>%
  filter(LRank <= 10) %>%
  group_by(Year) %>%
  summarize(top10Wins = n()) %>%
  mutate(Player = "Nadal")

ndTop10 <- ndMatches %>%
  filter(Winner == "Djokovic N.") %>%
  filter(LRank <= 10) %>%
  group_by(Year) %>%
  summarize(top10Wins = n()) %>%
  mutate(Player = "Djokovic")

top10 <- rbind(rfTop10, rnTop10, ndTop10)
  
ggplot(top10, mapping = aes(x=Year, y=top10Wins)) + 
  geom_bar(aes(fill = Player), position = "dodge", stat="identity") + 
  ggtitle("Top 10 Wins Per Year") + 
  ylab("Top 10 Wins") + xlab("Year") +
  scale_fill_manual(values=c("#999999", "#56B4E9", "#E69F00"))
  
```

Posible things to do:

- Analyze top 10 wins
- Analyze top 20/10 wins by surface
- Analyze wins in quarterfinals and above
- Analyze wins in finals
- Average rank of players faced by year
- Analyze biggest upsets
- Analyze dominant performances



### Hypothesis Testing & Machine Learning



### Message

